name: "Mac OS"

on: ["push"]

jobs:
  static:
    name: "Static Build"
    runs-on: "macos-latest"
    steps:
    - uses: "actions/checkout@v2"

    - name: "Print versions"
      run: |
        rustc --version
        cargo --version
        rustup --version

    - name: "Build"
      run: "cargo build --release" # this could be cargo run -- build, but... lol?

    - name: "Find"
      run: |
        ls
        ls target
        ls target/release

  release:
    name: "Publish Release"
    runs-on: "macos-latest"
    if: "startsWith(github.ref, 'refs/tags')"
    needs: ["static"]
    steps:

    - name: "Get version"
      id: "get_version"
      run: 'echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}'

    - name: "Download artifact"
      uses: "actions/download-artifact@v1"
      with:
        name: "mold"

    - name: "Create release"
      uses: "actions/create-release@v1"
      id: "create_release"
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"  # do I need this?
      with:
        tag_name: "${{ steps.get_version.outputs.VERSION }}"  # seems wrong
        release_name: "${{ steps.get_version.outputs.VERSION }}"  # seems wrong
        draft: true
        prerelease: false

    - name: "Upload release binary"
      id: "upload_binary"
      uses: "actions/upload-release-asset@v1.0.1"
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
      with:
        upload_url: "${{ steps.create_release.outputs.upload_url }}"
        asset_path: "mold/moldy"
        asset_name: "${{ format('mold-mac-{0}', steps.get_version.outputs.VERSION) }}"
        asset_content_type: "application/octet-stream"
